name: Sync Shopify Data

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  
  workflow_dispatch:  # Manual trigger button in GitHub Actions
  
  push:
    branches: [main]
    paths:
      - 'fetch_shopify_data.py'
      - '.github/workflows/sync-blog-data.yml'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Fetch Shopify Data
        env:
          SHOPIFY_SHOP_DOMAIN: ${{ secrets.SHOPIFY_SHOP_DOMAIN }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        run: |
          python fetch_shopify_data.py
      
      - name: Create README
        run: |
          cat > README.md << 'EOF'
          # Spacire Shopify Data API
          
          **Auto-updates every 30 minutes | All prices in GBP**
          
          ## Quick Access - Shopify Standard JSON
          
          | Data Type | URL |
          |-----------|-----|
          | All Products | [products.json](https://raw.githubusercontent.com/sytrre/spacire-blog-data/refs/heads/main/products.json) |
          | All Collections | [collections.json](https://raw.githubusercontent.com/sytrre/spacire-blog-data/refs/heads/main/collections.json) |
          | All Blogs | [blogs.json](https://raw.githubusercontent.com/sytrre/spacire-blog-data/refs/heads/main/blogs.json) |
          | Data Index | [data_index.json](https://raw.githubusercontent.com/sytrre/spacire-blog-data/refs/heads/main/data_index.json) |
          
          ## Collection-Specific Files
          
          Each collection has its own products file in the `collections/` directory:
          - [Blackout Curtains](https://raw.githubusercontent.com/sytrre/spacire-blog-data/refs/heads/main/collections/blackout-curtains_products.json)
          - [Sleep Masks](https://raw.githubusercontent.com/sytrre/spacire-blog-data/refs/heads/main/collections/sleep-masks_products.json)
          - [Weighted Blankets](https://raw.githubusercontent.com/sytrre/spacire-blog-data/refs/heads/main/collections/weighted-blankets_products.json)
          - [View all collections â†’](./collections)
          
          ## API Usage
          
          ```javascript
          // Fetch all products
          fetch('https://raw.githubusercontent.com/sytrre/spacire-blog-data/refs/heads/main/products.json')
            .then(res => res.json())
            .then(data => {
              console.log(data.products); // Array of products
            });
          
          // Fetch specific collection
          fetch('https://raw.githubusercontent.com/sytrre/spacire-blog-data/refs/heads/main/collections/sleep-masks_products.json')
            .then(res => res.json())
            .then(data => {
              console.log(data.products); // Products in this collection
            });
          ```
          
          Last updated: $(date)
          EOF
      
      - name: Commit and push changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .
          git diff --staged --quiet || git commit -m "Update Shopify data - $(date +'%Y-%m-%d %H:%M')"
          git push || echo "No changes to push"
